<!doctype html>
<script type="importmap">
{
  "imports": {
    "buffer": "https://cdn.jspm.io/npm:@jspm/core@1.0.4/nodelibs/buffer.js",
    "es-module-lexer": "https://cdn.jspm.io/npm:es-module-lexer@0.3.17/dist/lexer.cjs",
    "process": "https://cdn.jspm.io/npm:@jspm/core@1.0.4/nodelibs/process.js",
    "semver/": "https://cdn.jspm.io/npm:semver@6.3.0/",
    "sver": "https://cdn.jspm.io/npm:sver@1.8.3/sver.js",
    "sver/convert-range.js": "https://cdn.jspm.io/npm:sver@1.8.3/convert-range.js"
  }
}
</script>
<script type="module">
  import runTests from './src/runner.js';
  import { createMapLoader } from './src/loader.js';

  const dev = true;
  const system = false;

  function systemReplace (map) {
    for (const name of Object.keys(map.imports)) {
      map.imports[name] = 'https://ga.system.jspm.io/' + map.imports[name].slice('https://ga.jspm.io/'.length);
    }
    if (map.scopes)
      for (const scope of Object.keys(map.scopes)) {
        const imports = map.scopes[scope];
        delete map.scopes[scope];
        map.scopes['https://ga.system.jspm.io/' + scope.slice('https://ga.jspm.io/'.length)] = imports;
        for (const name of Object.keys(imports)) {
          imports[name] = 'https://ga.system.jspm.io/' + imports[name].slice('https://ga.jspm.io/'.length);
        }
      }
    return map;
  }

  async function loadAndCreateMap (url, system) {
    let map = await (await fetch(url)).json();
    if (system)
      map = systemReplace(map);
    return createMapLoader(map, system);
  }

  (async () => {
    const tests = eval(await (await fetch('./tests.js')).text());

    await runTests(await Promise.all(tests.map(async (test, index) => {
      const [installs, specifiers] = typeof test === 'string' ? [test, test] : test;
      return {
        test: installs,
        async run () {
          let loader;
          if (dev)
            loader = createMapLoader({});
          else
            loader = await loadAndCreateMap(`./maps/${encodeURIComponent(encodeURIComponent(installs))}.json`, system);
          for (const specifier of specifiers.split(' ')) {
            const m = await loader.import((dev ? 'https://jspm.dev/' : '') + specifier);
            // for debugging
            window.m = m;
          }
          loader.dispose();
        }
      };
    })));

    const testList = await (await fetch('./test-list.json')).json();
    const skip = eval(await (await fetch('./skip-list.js')).text());
    const startAt = 0;
    runTests(await Promise.all(testList.filter((test, i) => !skip.includes(test) && i >+ startAt).map(async (test, index) => {
      return {
        test,
        async run () {
          if (window.stopped)
            return;
          if (dev)
            loader = createMapLoader({});
          else {
            try {
              var loader = await loadAndCreateMap(`./maps/${encodeURIComponent(encodeURIComponent(test))}.json`, system);
              // if (!map.imports[test])
              //   throw new Error('Test TODO: export subpaths checks');
            }
            catch (e) {
              throw new Error('No map for ' + test);
              return;
            }
          }
          const m = await loader.import((dev ? 'https://test.jspm.io/' : '') + test);
          window.m = m;
          loader.dispose();
        }
      };
    })));
  })();
</script>
<style>
  * {
    font-family: sans-serif;
    letter-spacing: 0.05em;
  }
  body {
    background-color: #fffaf0;
    color: #324;
  }
  h1 {
    font-size: 1.3em;
    text-align: center;
    font-weight: 100;
    text-transform: uppercase;
    color: rgb(223, 145, 0);
    text-shadow: #fff 2px 2px 2px;
  }
  .status {
    font-size: 1em;
  }
  ul.results {
    list-style-type: none;
    font-size: 0.8em;
    padding-left: 1em;
  }
  ul.results li .err {
    color: #720e0e;
    font-style: italic;
  }
</style>
<body>
  <h1>jspm test runner</h1>
</body>
